# 使用指南

## 交互式CLI功能详解

### 功能亮点

1. **版本确认** - 每次执行前都会询问确认版本号，防止误操作
2. **完整输出展示** - 显示脚本的完整stdout和stderr，不截断
3. **基于输出决策** - 查看完整输出后，再决定是否继续
4. **详细反馈** - 每步执行后都有清晰的成功/失败提示
5. **步骤等待** - 完整流程中，每步完成后会等待你确认是否继续
6. **下一步提示** - 明确告诉你接下来要做什么
7. **进度显示** - 可视化进度条，清楚当前执行到哪一步

### 单个任务执行流程

#### 1. 检查资源完整性

```bash
node src/cli.js check -v v885
```

**执行过程：**

1. **版本确认阶段**
   ```
   ============================================================
     准备执行: 资源完整性检查
   ============================================================

   ? 确认版本号是 v885 吗? (Y/n)
   ```
   - 输入 `Y` 或直接回车继续
   - 输入 `n` 取消操作

2. **执行阶段**
   ```
   🚀 开始执行: 资源完整性检查
      版本: v885
      时间: 2025-11-26 10:30:00
   ```

3. **检查详情显示**
   ```
   检查详情:

   ✅ 1. Check iOS resources - 通过
   ✅ 2. Check Android resources - 通过
   ✅ 3. Match version - 通过
   ```

4. **完整脚本输出**
   ```
   📄 Check iOS resources - 脚本输出:
   ────────────────────────────────────────────────────────────
   Checking iOS manifest...
   Loading seed: /home/ec2-user/wtc/assets_config/common_ios/project.manifest
   Verifying resources in: /home/ec2-user/wtc/v885/res_oldvegas/
   All files matched successfully.
   Total files checked: 1245
   ────────────────────────────────────────────────────────────
   ```

   **重要**：这是脚本的原始输出，你可以根据这些信息判断：
   - 检查了哪些文件
   - 是否有警告信息
   - 具体的执行细节
   - 是否真的成功了

5. **结果反馈**
   ```
   ============================================================
   ✅ 资源完整性检查 - 执行成功
   ============================================================
   📦 版本: v885
   💬 版本 v885 资源无异常，所有检查项通过

   详细信息:
     • iOS资源: ✅ 完整
     • Android资源: ✅ 完整
     • 版本匹配: ✅ 通过
   ============================================================
   ```

**如果检查失败：**
```
============================================================
❌ 资源完整性检查 - 执行失败
============================================================
📦 版本: v885
💥 错误: 部分资源检查未通过，请查看上方详情

提示: 请查看日志文件了解详细信息
============================================================
```

#### 2. 同步Facebook资源

```bash
node src/cli.js sync-fb -v v885
```

**成功反馈示例：**
```
============================================================
✅ Facebook资源同步 - 执行成功
============================================================
📦 版本: v885
💬 版本 v885 的Facebook资源已成功同步到生产环境

详细信息:
  • 同步状态: ✅ 完成
  • 同步时间: 2025-11-26 10:35:00
============================================================

脚本输出:
Syncing Facebook resources...
Upload complete.
...
```

#### 3. 同步Native资源

```bash
node src/cli.js sync-native -v v885
```

类似于Facebook资源同步，会有相同的确认和反馈流程。

#### 4. 更新Reuse版本

```bash
node src/cli.js update-reuse -v v885
```

**成功反馈示例：**
```
============================================================
✅ Reuse版本更新 - 执行成功
============================================================
📦 版本: v885
💬 版本 v885 已成功移动到reuse_version

详细信息:
  • WTC版本: v885 → reuse_version
  • WTC_FB版本: v885 → reuse_version
  • Nginx版本: v883 → reuse_version
============================================================
```

### 完整发布流程（推荐）

```bash
node src/cli.js full-sync -v v885
```

这是最推荐的使用方式，会**自动按顺序执行**所有步骤，并在每步之间等待你的确认。

**完整执行流程：**

1. **初始确认**
   ```
   🚀 完整发布流程

   版本: v885
   时间: 2025-11-26 10:30:00

   ============================================================
     准备执行: 完整发布流程
   ============================================================

   ? 确认版本号是 v885 吗? (Y/n)
   ```

2. **步骤1：检查资源完整性**
   ```
   进度: [██████████░░░░░░░░░░░░░░░░░░░░] 33% (1/3)
   当前步骤: 检查资源完整性

   🚀 开始执行: 检查资源完整性
      版本: v885
      时间: 2025-11-26 10:30:15

   [执行检查...]

   ✅ 资源完整性检查 - 执行成功
   ```

3. **完整脚本输出显示**
   ```
   📄 检查资源完整性 - 脚本输出:
   ────────────────────────────────────────────────────────────
   Checking iOS manifest...
   All files matched successfully.
   Total files checked: 1245
   ────────────────────────────────────────────────────────────

   ✅ 检查资源完整性 - 执行成功
   ```

4. **基于输出的确认**
   ```
   ────────────────────────────────────────────────────────────
   📋 下一步: 同步Facebook资源
   ────────────────────────────────────────────────────────────

   ? 根据上方输出，确认继续执行吗? (Y/n)
   ```

   **重要改变**：
   - **之前**: 直接询问是否继续，没看到输出内容
   - **现在**: 先显示完整脚本输出，然后询问
   - **优势**: 你可以根据实际输出判断是否真的成功了

   **决策依据**：
   - 输出中是否有ERROR或FAILED字样？
   - 文件数量是否正确？
   - 是否有意外的警告信息？
   - 执行时间是否正常？

4. **步骤2：同步Facebook资源**
   ```
   进度: [████████████████████░░░░░░░░░░] 66% (2/3)
   当前步骤: 同步Facebook资源

   🚀 开始执行: 同步Facebook资源
   [...]
   ✅ Facebook资源同步 - 执行成功
   ```

5. **再次等待确认**
   ```
   ────────────────────────────────────────────────────────────
   📋 下一步: 同步Native资源
   ────────────────────────────────────────────────────────────

   ? 请选择操作: ✅ 继续执行
   ```

6. **步骤3：同步Native资源**
   ```
   进度: [██████████████████████████████] 100% (3/3)
   当前步骤: 同步Native资源

   🚀 开始执行: 同步Native资源
   [...]
   ✅ Native资源同步 - 执行成功
   ```

7. **总结**
   ```
   ============================================================
     执行摘要
   ============================================================
     版本: v885
     总任务数: 3
     成功: 3

     🎉 所有任务执行成功！
   ============================================================

   🎉 完整发布流程执行成功!
   ```

### 跳过确认模式

如果你确信版本号无误，或者在自动化脚本中使用，可以跳过确认：

```bash
# 单个任务跳过确认
node src/cli.js check -v v885 --no-confirm

# 完整流程跳过所有确认（危险！）
node src/cli.js full-sync -v v885 --no-confirm
```

⚠️ **警告**：`--no-confirm` 会跳过所有安全确认，请谨慎使用！

### 高级用法

#### 跳过资源检查的完整流程

如果你已经手动检查过资源，可以跳过检查步骤：

```bash
node src/cli.js full-sync -v v885 --skip-check
```

这样流程会变成：
1. 同步Facebook资源
2. 同步Native资源

#### 查看日志

所有操作都会记录到日志文件：

```bash
# 查看所有日志
tail -f logs/combined.log

# 查看错误日志
tail -f logs/error.log

# 查看最近100行
tail -n 100 logs/combined.log
```

### 错误处理

**场景1：版本号输入错误**

```
❌ 错误: Invalid version format: v88. Expected format: v123 or 123
```

解决：检查版本号格式，确保是 `v885` 这样的格式。

**场景2：资源检查失败**

```
检查详情:

✅ 1. Check iOS resources - 通过
❌ 2. Check Android resources - 失败
   错误: manifest file not found...

❌ 资源完整性检查 - 执行失败
```

解决：
1. 查看详细错误信息
2. 检查 `logs/error.log` 了解完整错误
3. 修复问题后重新执行

**场景3：同步中断**

如果在完整流程中选择了"取消退出"：

```
? 请选择操作: ❌ 取消退出

❌ 操作已取消

流程在 "检查资源完整性" 后停止
```

解决：
- 已完成的步骤不会自动回滚
- 可以从下一步继续执行：`node src/cli.js sync-fb -v v885`
- 或重新执行完整流程

### 最佳实践

1. **首次使用建议**
   - 使用交互式模式（默认），熟悉整个流程
   - 在测试环境先验证一遍
   - 检查日志确保没有警告

2. **生产环境发布**
   - 使用 `full-sync` 命令执行完整流程
   - 每步完成后检查输出确认无误
   - 保持 `--confirm` 开启，防止误操作

3. **自动化脚本**
   - 只在完全确认的情况下使用 `--no-confirm`
   - 建议添加预检查脚本
   - 记录所有操作到外部日志系统

4. **紧急情况**
   - 选择"暂停"选项，检查当前状态
   - 查看日志文件了解详情
   - 必要时选择"取消退出"，手动处理

### 示例场景

#### 场景：正常发布新版本

```bash
# 1. 先单独检查资源
node src/cli.js check -v v886
# 确认通过

# 2. 执行完整发布
node src/cli.js full-sync -v v886
# 每步确认后继续

# 3. 发布完成后，更新reuse版本
node src/cli.js update-reuse -v v886
```

#### 场景：只更新Facebook渠道

```bash
node src/cli.js sync-fb -v v885
```

#### 场景：紧急回滚到reuse版本

```bash
# 手动确认要回滚的版本
node src/cli.js update-reuse -v v885 -n v883
```

### 关于完整输出显示

### 为什么要显示完整输出？

1. **返回码不够可靠**
   - 有些脚本即使失败也返回0（成功）
   - 有些脚本有警告但仍返回成功
   - 只看返回码无法了解执行细节

2. **需要人工判断**
   - 同步了多少文件？
   - 是否有跳过的资源？
   - 警告信息是否可接受？
   - 实际执行时间是否正常？

3. **便于问题诊断**
   - 失败时可以立即看到错误信息
   - 不需要再去查日志文件
   - 可以截图给团队成员

### 输出内容说明

**stdout（标准输出）**
- 脚本的正常执行信息
- 进度提示
- 成功消息
- 统计数据

**stderr（标准错误输出）**
- ⚠️ 不一定是错误！
- 可能只是警告信息
- 某些工具会把日志输出到stderr
- 需要根据具体内容判断

### 如何根据输出判断成功/失败？

**成功的标志：**
- ✅ 出现 "success"、"completed"、"done" 等字样
- ✅ 文件数量符合预期
- ✅ 没有 "error"、"failed" 字样
- ✅ stderr为空或只有无关紧要的警告

**失败的标志：**
- ❌ 出现 "error"、"failed"、"abort" 等字样
- ❌ 文件数量不对
- ❌ stderr中有明确的错误信息
- ❌ 执行时间异常短（可能立即失败了）

**可疑的情况（需要进一步检查）：**
- ⚠️ 有警告但继续执行
- ⚠️ 跳过了某些文件
- ⚠️ 文件数量与预期不完全一致
- ⚠️ 执行时间异常

## 常见问题

**Q: 输出太长怎么办？**

A: 可以滚动终端查看，或者查看日志文件 `logs/combined.log`

**Q: 如果某一步失败了会怎样？**

A: 流程会立即终止，并显示错误信息。已完成的步骤不会自动回滚。

**Q: 如何在不确认的情况下运行？**

A: 添加 `--no-confirm` 参数，但请谨慎使用。不推荐在生产环境使用。

**Q: 日志文件在哪里？**

A: 在项目根目录的 `logs/` 文件夹中。

**Q: MCP调用时也有完整输出吗？**

A: 是的！MCP返回的JSON中包含完整的stdout和stderr字段。

**Q: 脚本输出中有中文乱码怎么办？**

A: 确保终端支持UTF-8编码。macOS和现代Linux通常默认支持。
